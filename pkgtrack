#!/bin/bash
set -e

DATA_DIR="$HOME/.local/share/pkgtrack"
SNAP_DIR="$DATA_DIR/snaps"
mkdir -p "$SNAP_DIR"

BEFORE="$DATA_DIR/pkg-before.txt"
AFTER="$DATA_DIR/pkg-after.txt"
DIFF="$DATA_DIR/pkg-diff.txt"

case "$1" in
  before)
    sudo pacman -Qq | sort > "$BEFORE"
    echo "üì¶ Package snapshot saved ‚Üí $BEFORE"
    ;;

  after)
    if [ ! -f "$BEFORE" ]; then
      echo "‚ùå No previous snapshot found. Run 'pkgtrack before' first."
      exit 1
    fi
    sudo pacman -Qq | sort > "$AFTER"
    comm -13 "$BEFORE" "$AFTER" > "$DIFF"
    echo "üÜï New packages since last snapshot:"
    if [ -s "$DIFF" ]; then
      cat "$DIFF"
    else
      echo "No new packages."
    fi
    ;;

  rollback)
    if [ ! -s "$DIFF" ]; then
      echo "‚ùå No diff found. Run 'pkgtrack after' first."
      exit 1
    fi
    echo "‚ö†Ô∏è The following packages will be removed:"
    cat "$DIFF"
    echo
    read -p "Proceed with removal? [y/N]: " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      sudo pacman -Rns --noconfirm $(cat "$DIFF")
      echo "üßπ Rollback complete."

      mv "$BEFORE" "$BEFORE.old" 2>/dev/null || true
      mv "$AFTER" "$AFTER.old" 2>/dev/null || true
      mv "$DIFF" "$DIFF.old" 2>/dev/null || true
      echo "üìÅ Old snapshot files renamed to *.old"
    else
      echo "‚ùé Rollback cancelled."
    fi
    ;;

  snap)
    PKG="$2"
    if [ -z "$PKG" ]; then
      echo "Usage: pkgtrack snap <package>"
      exit 1
    fi
    if [ ! -s "$DIFF" ]; then
      echo "‚ùå No diff found. Run 'pkgtrack after' first."
      exit 1
    fi
    FILE="$SNAP_DIR/${PKG}.txt"
    cp "$DIFF" "$FILE"
    echo "üì∏ Snapshot for '$PKG' saved ‚Üí $FILE"
    ;;

  remove)
    PKG="$2"
    if [ -z "$PKG" ]; then
      echo "Usage: pkgtrack remove <package>"
      exit 1
    fi
    FILE="$SNAP_DIR/${PKG}.txt"
    if [ ! -f "$FILE" ]; then
      echo "‚ùå No snapshot found for '$PKG'."
      exit 1
    fi
    echo "‚ö†Ô∏è The following packages will be removed:"
    cat "$FILE"
    echo
    read -p "Proceed with removal? [y/N]: " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      sudo pacman -Rns --noconfirm $(cat "$FILE")
      echo "üßπ Snapshot '$PKG' removed successfully."
    else
      echo "‚ùé Removal cancelled."
    fi
    ;;

  *)
    echo "Usage: pkgtrack before|after|rollback|snap <pkg>|remove <pkg>"
    ;;
esac
